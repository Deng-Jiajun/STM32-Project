#include "sys.h"
#include "oledfont.h"

/* åªç”¨äºæ¨¡å—å†…éƒ¨è°ƒç”¨çš„å‡½æ•° ğŸ‘‡ */

void __OLED_Send_Command(uint8_t cmd);
void __OLED_Send_Data(uint8_t data);
void __OLED_Set_Pos(uint8_t x, uint8_t y);
void __OLED_ShowChar(uint8_t x, uint8_t y, char ch, uint8_t size);
void __OLED_ShowChineseChar(uint8_t x, uint8_t y, uint8_t index, uint8_t size);
void __OLED_ShowStr(uint8_t x, uint8_t y, char *str, uint8_t size);
void __OLED_ShowNum(uint8_t x, uint8_t y, int num, uint8_t size);
void __OLED_Int2Str(int num, char *str);

/**
 * @brief å…³äºåæ ‡ç³»
 * xï¼Œä»å·¦åˆ°å³ï¼ˆä» 0 åˆ° 127ï¼Œå•ä½ä¸º SEGï¼‰ï¼Œyï¼Œä»ä¸Šåˆ°ä¸‹ï¼ˆä» 0 åˆ° 7ï¼Œå•ä½ä¸º PAGEï¼‰
 * x: 0----->127
 * y: 0
 *    |
 *    |
 *    |
 *    v
 *    7
 */

/**
 * @brief OLED åˆå§‹åŒ–
 *
 */
void OLED_Init(void)
{
    /* IIC åˆå§‹åŒ– */
    IIC_Init();

    /* åˆå§‹åŒ–å‰å»¶æ—¶ä¸€æ®µæ—¶é—´ */
    delay_ms(800);

    /* å…³é—­æ˜¾ç¤ºï¼ˆå¼€å§‹é…ç½®/åˆå§‹åŒ– OLEDï¼‰ */
    __OLED_Send_Command(0xAE); // Set Display ON/OFF
    /** ğŸ‘†
     * 1 0 1 0 1 1 1 X0
     * AEh, X[0]=0b:Display OFF (sleep mode) (RESET)
     * AFh, X[0]=1b:Display ON in normal mode
     */

    /* è®¾ç½®æ—¶é’Ÿåˆ†é¢‘ç³»æ•°/éœ‡è¡é¢‘ç‡ */
    __OLED_Send_Command(0xD5); // Set Display Clock Divide Ratio/Oscillator Frequency
    __OLED_Send_Command(0x80); // é»˜è®¤å€¼ 0x80
    /** ğŸ‘†
     * [3:0] : Define the divide ratio (D) of the display clocks (DCLK):
     * Divide ratio= [3:0] + 1, RESET is 0000b (divide ratio = 1)
     *
     * [7:4] :Set the Oscillator Frequency, FOSC.
     * Oscillator Frequency increases with the value of [7:4] and vice versa.
     * RESET is 1000b Range:0000b~1111b
     * Frequency increases as setting value increases.
     */

    // è¿™ä¸ªå’Œ COM å¥½åƒæœ‰å…³
    /* è®¾ç½®é©±åŠ¨è·¯æ•° */
    __OLED_Send_Command(0xA8); // Set Multiplex Ratio
    __OLED_Send_Command(0x3F); // é»˜è®¤å€¼ 0x3F(63, 1/64 duty)
    /** ğŸ‘†
     * N=[5:0] : from 16MUX to 64MUX, RESET= 111111b (i.e. 63d, 64MUX)
     *           from 0 to 14 are invalid entry.
     */

    /* è®¾ç½®æ˜¾ç¤ºåç§» ä½ç§»æ˜ å°„ RAM è®¡æ•°å™¨ */
    __OLED_Send_Command(0xD3); // Set Display Offset
    __OLED_Send_Command(0x00); // é»˜è®¤å€¼ 0x00
    /**ğŸ‘†
     * Set vertical shift by COM from 0d~63d The value is reset to 00h after RESET.
     */

    /* è®¾ç½®æ˜¾ç¤ºå¼€å§‹è¡Œï¼ˆè¡Œæ•°ï¼š[5:0]ï¼‰æ˜ å°„ RAM æ˜¾ç¤ºèµ·å§‹è¡Œ(0x00~0x3F) */
    __OLED_Send_Command(0x40); // Set Display Start Lineï¼Œé»˜è®¤å€¼ 0x40 ï¼ˆ01å¼€å¤´ï¼‰
    /** ğŸ‘†
     * Set display RAM display start line register from 0-63 using X5X3X2X1X0.
     * Display start line register is reset to 000000b during RESET.
     */

    /* è®¾ç½®ç”µè·æ³µ */
    __OLED_Send_Command(0x8D); // Charge Pump Setting
    __OLED_Send_Command(0x14); // å¼€å¯ç”µè·æ³µï¼ˆbit2=1ï¼‰
    /** ğŸ‘†
     * A[7:0]ï¼š* * 0 1 0 A2 0 0
     * A[2] = 0b, Disable charge pump(RESET)
     * A[2] = 1b, Enable charge pump during display on
     *
     * Note
     * The Charge Pump must be enabled by the following command:
     * 8Dh ; Charge Pump Setting
     * 14h ; Enable Charge Pump
     * AFh; Display ON
     */

    /* ----- çºµå‘ï¼šCOM0 ~ COM63ï¼› æ¨ªå‘ï¼šSEG0 ~ SEG127 ----- */

    /* SEG é‡æ˜ å°„ï¼ˆæ°´å¹³ç¿»è½¬ï¼Œåˆ—é‡æ˜ å°„ï¼‰ */
    __OLED_Send_Command(0xA1); // Set Segment Re-map
    /** ğŸ‘†
     * A0h, X[0]=0b: column address 0 is mapped to SEG0 (RESET)
     * A1h, X[0]=1b: column address 127 is mapped to SEG0
     */

    /* COM æ‰«ææ–¹å‘é‡æ˜ å°„ï¼ˆå‚ç›´ç¿»è½¬ï¼Œè¡Œé‡æ˜ å°„ï¼‰ */
    __OLED_Send_Command(0xC8); // Set COM Output Scan Direction
    /** ğŸ‘†
     * 1 1 0 0 X3 0 0 0
     * C0h, X[3]=0b: normal mode (RESET) Scan from COM0 to COM[N â€“1]
     * C8h, X[3]=1b: remapped mode. Scan from COM[N-1] to COM0
     * Where N is the Multiplex ratio.
     */

    /* è®¾ç½® COM ç¡¬ä»¶å¼•è„šé…ç½® */
    __OLED_Send_Command(0xDA); // Set COM Pins Hardware Configuration
    __OLED_Send_Command(0x12); // é»˜è®¤å€¼ 0x12ï¼ˆç¦ç”¨å·¦å³é‡æ˜ å°„ï¼‰
    /** ğŸ‘†
     * 0 0 A5 A4 0 0 1 0
     * A[4]=0b, Sequential COM pin configuration
     * A[4]=1b(RESET), Alternative COM pin configuration
     * A[5]=0b(RESET), Disable COM Left/Right remap
     * A[5]=1b, Enable COM Left/Right remap
     */

    /* è®¾ç½®å¯¹æ¯”åº¦ */
    __OLED_Send_Command(0x81); // Set Contrast Control
    __OLED_Send_Command(0xCF); // ã€ŒVCC Generated by Internal DC/DC Circuitã€
    /** ğŸ‘†
     * to select 1 out of 256 contrast steps.
     * Contrast increases as the value increases. (RESET = 7Fh )
     */

    /* è®¾ç½®é¢„å……ç”µå‘¨æœŸ */
    __OLED_Send_Command(0xD9); // Set Pre-charge Period
    __OLED_Send_Command(0xF1); // ã€ŒVCC Generated by Internal DC/DC Circuitã€
    /** ğŸ‘†
     * A[3:0] : Phase 1 period of up to 15 DCLK
     *          clocks 0 is invalid entry (RESET=2h)
     * A[7:4] : Phase 2 period of up to 15 DCLK
     *          clocks 0 is invalid entry (RESET=2h )
     */

    /* è®¾ç½® VCOMH ç”µå‹å€ç‡ */
    __OLED_Send_Command(0xDB); // Set VCOMH Deselect Level
    __OLED_Send_Command(0x30); // 0.83 x VCC
    /** ğŸ‘†
     * adjusts the VCOMH regulator output.
     * 0 A6 A5 A4 0 0 0 0
     * [6:4] : VCOMH Deselect Level
     * 000: 0.65 x VCC
     * 001: 0.77 x VCC (RESET)
     * 011: 0.83 x VCC
     */

    /* è®¾ç½®å…¨å±€æ˜¾ç¤º */
    __OLED_Send_Command(0xA4); // Set Entire Display On/Offï¼ˆé»˜è®¤å€¼ 0xA4ï¼‰
    /** ğŸ‘†
     * 1 0 1 0 0 1 0 X0
     * A4h, X0=0b: Resume to RAM content display (RESET)
     *             Output follows RAM content
     * A5h, X0=1b: Entire display ON
     *             Output ignores RAM content
     */

    /* æ­£å¸¸æ˜¾ç¤ºæ¨¡å¼ */
    __OLED_Send_Command(0xA6); // Set Normal/Inverse Displayï¼ˆé»˜è®¤å€¼ 0xA6ï¼‰
    /** ğŸ‘†
     * 1 0 1 0 0 1 1 X0
     * A6h, X[0]=0b: Normal display (RESET)
     *      0 in RAM: OFF in display panel
     *      1 in RAM: ON in display panel
     * A7h, X[0]=1b: Inverse display
     *      0 in RAM: ON in display panel
     *      1 in RAM: OFF in display panel
     */

    /* è®¾ç½®å¯»å€æ¨¡å¼ï¼ˆé¡µå¯»å€ï¼‰ */
    __OLED_Send_Command(0x20); // Set Memory Addressing Mode
    __OLED_Send_Command(0x02); // é¡µå¯»å€æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
    /** ğŸ‘†
     * * * * * * * A1 A0
     * A[1:0] = 00b, Horizontal Addressing Mode
     * A[1:0] = 01b, Vertical Addressing Mode
     * A[1:0] = 10b, Page Addressing Mode (RESET)
     * A[1:0] = 11b, Invalid
     */

    /**
     * @note åŸºæœ¬å¯ä»¥ç¡®å®šï¼Œé’ˆå¯¹é¡µå¯»å€æ¨¡å¼èµ·å§‹åœ°å€çš„è¿™éƒ¨åˆ†é…ç½®æ²¡æœ‰å®é™…ä½œç”¨ï¼Œå› ä¸º
     * æ¯æ¬¡æ˜¾ç¤ºå†…å®¹å‰ï¼Œéƒ½ä¼šé‡æ–°è®¾ç½®èµ·å§‹åœ°å€ï¼Œä½†æ˜¯å› ä¸ºå†™äº†å…·ä½“æè¿°ï¼Œæ‰€ä»¥äºˆä»¥ä¿ç•™
     */

    /* è®¾ç½®é¡µå¯»å€æ¨¡å¼çš„é¡µé¢èµ·å§‹åœ°å€ */
    __OLED_Send_Command(0xB0); // Set Page Start Address for Page Addressing Mode
    /** ğŸ‘†
     * 1 0 1 1 0 X2 X1 X0    ï¼ˆB0~B7ï¼‰
     * Set GDDRAM Page Start Address (PAGE0~PAGE7) for Page Addressing Mode using X[2:0].
     */

    /* è®¾ç½®é¡µå¯»å€æ¨¡å¼çš„ä½åˆ—èµ·å§‹åœ°å€ï¼ˆé»˜è®¤å€¼ 0x00ï¼‰ */
    __OLED_Send_Command(0x00); // Set Lower Column Start Address for Page Addressing Mode
    /** ğŸ‘†
     * 0 0 0 0 X3 X2 X1 X0    ï¼ˆ00~0Fï¼‰
     * Set the lower nibble of the column start address register for Page Addressing Mode using X[3:0] as data bits.
     * The initial display line register is reset to 0000b after RESET.
     */

    /* è®¾ç½®é¡µå¯»å€æ¨¡å¼çš„é«˜åˆ—èµ·å§‹åœ°å€ï¼ˆé»˜è®¤å€¼ 0x10ï¼‰ */
    __OLED_Send_Command(0x10); // Set Higher Column Start Address for Page Addressing Mode
    /** ğŸ‘†
     * 0 0 0 1 X3 X2 X1 X0    ï¼ˆ10~1Fï¼‰
     * Set the higher nibble of the column start address register for Page Addressing Mode using X[3:0] as data bits.
     * The initial display line register is reset to 0000b after RESET.
     */

    /* æ¸…å± */
    OLED_Clear();

    /* å¼€å¯æ˜¾ç¤ºï¼ˆç»“æŸé…ç½®/åˆå§‹åŒ– OLEDï¼‰ */
    __OLED_Send_Command(0xAF); // Set Display ON/OFF
    /** ğŸ‘†
     * 1 0 1 0 1 1 1 X0
     * AEh, X[0]=0b:Display OFF (sleep mode) (RESET)
     * AFh, X[0]=1b:Display ON in normal mode
     */
}

/**
 * @brief å‘ OLED å‘é€å‘½ä»¤
 *
 * @param cmd å‘é€çš„å‘½ä»¤å­—èŠ‚
 */
void __OLED_Send_Command(uint8_t cmd)
{
    /* èµ·å§‹ä¿¡å· */
    IIC_Start();

    /**
     * @brief å‘é€ä»æœºåœ°å€ï¼ˆå†™æ¨¡å¼ï¼‰
     *
     * 0 1 1 1 1 0 SA0 R/W#
     * SA0 é»˜è®¤æ˜¯ 0ï¼ˆé€šè¿‡ D/C å¼•è„šæ”¹å˜ï¼‰
     * R/W# = 0 æ˜¯å†™æ¨¡å¼
     * R/W# = 1 æ˜¯è¯»æ¨¡å¼
     */
    IIC_Send_Data(OLED_Slave_Address_Write); // ä¹Ÿå¯å†™æˆ IIC_Send_Data(0x3C<<1);

    /**
     * @brief è·Ÿåœ¨ä»æœºåœ°å€åé¢çš„ä¸€ä¸ªå­—èŠ‚
     *
     * Co D/C# 0 0 0 0 0 0
     *
     * Co=0ï¼Œåé¢ä¼ è¾“çš„éƒ½æ˜¯æ•°æ®å­—èŠ‚

     * D/C#=0ï¼Œä¸‹ä¸€ä¸ªæ•°æ®å­—èŠ‚è¢«çœ‹ä½œå‘½ä»¤
     * D/C#=1ï¼Œä¸‹ä¸€ä¸ªæ•°æ®å­—èŠ‚è¢«çœ‹ä½œæ•°æ®ï¼Œå°†ä¼šå­˜åœ¨ GDDRAM ä¸­ï¼ŒGDDRAM åˆ—åœ°å€æŒ‡é’ˆå°†ä¼šåœ¨æ¯æ¬¡æ•°æ®å†™ä¹‹åè‡ªåŠ¨åŠ  1
     */
    /**
     * If the Co bit is set as logic â€œ0â€, the transmission of the following information will contain data bytes only.
     *
     * The D/C# bit determines the next data byte is acted as a command or a data.
     * - If the D/C# bit is set to logic â€œ0â€, it defines the following data byte as a command.
     * - If the D/C# bit is set to logic â€œ1â€, it defines the following data byte as a data which will be stored at the GDDRAM.
     *   The GDDRAM column address pointer will be increased by one automatically after each data write.
     */
    IIC_Send_Data(0x00); // ä¸‹ä¸€ä¸ªæ•°æ®å­—èŠ‚è¢«çœ‹ä½œå‘½ä»¤

    /* å‘é€å‘½ä»¤ */
    IIC_Send_Data(cmd);

    /* åœæ­¢ä¿¡å· */
    IIC_Stop();
}

/**
 * @brief å‘ OLED å‘é€æ•°æ®
 *
 * @param data å‘é€çš„æ•°æ®å­—èŠ‚
 */
void __OLED_Send_Data(uint8_t data)
{ /* èµ·å§‹ä¿¡å· */
    IIC_Start();

    /**
     * @brief å‘é€ä»æœºåœ°å€ï¼ˆå†™æ¨¡å¼ï¼‰
     *
     * 0 1 1 1 1 0 SA0 R/W#
     * SA0 é»˜è®¤æ˜¯ 0ï¼ˆé€šè¿‡ D/C å¼•è„šæ”¹å˜ï¼‰
     * R/W# = 0 æ˜¯å†™æ¨¡å¼
     * R/W# = 1 æ˜¯è¯»æ¨¡å¼
     */
    IIC_Send_Data(OLED_Slave_Address_Write); // ä¹Ÿå¯å†™æˆ IIC_Send_Data(0x3C<<1);

    /**
     * @brief è·Ÿåœ¨ä»æœºåœ°å€åé¢çš„ä¸€ä¸ªå­—èŠ‚
     *
     * Co D/C# 0 0 0 0 0 0
     *
     * Co=0ï¼Œåé¢ä¼ è¾“çš„éƒ½æ˜¯æ•°æ®å­—èŠ‚

     * D/C#=0ï¼Œä¸‹ä¸€ä¸ªæ•°æ®å­—èŠ‚è¢«çœ‹ä½œå‘½ä»¤
     * D/C#=1ï¼Œä¸‹ä¸€ä¸ªæ•°æ®å­—èŠ‚è¢«çœ‹ä½œæ•°æ®ï¼Œå°†ä¼šå­˜åœ¨ GDDRAM ä¸­ï¼ŒGDDRAM åˆ—åœ°å€æŒ‡é’ˆå°†ä¼šåœ¨æ¯æ¬¡æ•°æ®å†™ä¹‹åè‡ªåŠ¨åŠ  1
     */
    /**
     * If the Co bit is set as logic â€œ0â€, the transmission of the following information will contain data bytes only.
     *
     * The D/C# bit determines the next data byte is acted as a command or a data.
     * - If the D/C# bit is set to logic â€œ0â€, it defines the following data byte as a command.
     * - If the D/C# bit is set to logic â€œ1â€, it defines the following data byte as a data which will be stored at the GDDRAM.
     *   The GDDRAM column address pointer will be increased by one automatically after each data write.
     */
    IIC_Send_Data(0x40); // ä¸‹ä¸€ä¸ªæ•°æ®å­—èŠ‚è¢«çœ‹ä½œæ•°æ®

    /* å‘é€æ•°æ® */
    IIC_Send_Data(data);
    /* åœæ­¢ä¿¡å· */
    IIC_Stop();
}

/**
 * @brief OLED æ¸…å±ï¼ˆç†„å±ï¼‰
 *
 */
void OLED_Clear(void)
{
    uint8_t i, j;
    for (i = 0; i < 8; i++)
    {
        __OLED_Send_Command(0xB0 + i); // è®¾ç½®é¡µèµ·å§‹åœ°å€ï¼ˆ0 ~ 7ï¼‰
        __OLED_Send_Command(0x00);     // è®¾ç½®ä½åˆ—èµ·å§‹åœ°å€ï¼ˆé»˜è®¤å€¼ 0x00ï¼‰
        __OLED_Send_Command(0x10);     // è®¾ç½®é«˜åˆ—èµ·å§‹åœ°å€ï¼ˆé»˜è®¤å€¼ 0x10ï¼‰

        /* 8 ä¸ª é¡µï¼ˆPAGEï¼‰ çš„ 128 åˆ—ï¼ˆSEGï¼‰ å…¨éƒ¨å†™ 0 */
        for (j = 0; j < 128; j++)
            __OLED_Send_Data(0);
    }
}

/**
 * @brief OLED å…¨å±ç‚¹äº®
 *
 */
void OLED_On(void)
{
    uint8_t i, j;
    for (i = 0; i < 8; i++)
    {
        __OLED_Send_Command(0xB0 + i); // è®¾ç½®é¡µèµ·å§‹åœ°å€ï¼ˆ0 ~ 7ï¼‰
        __OLED_Send_Command(0x00);     // è®¾ç½®ä½åˆ—èµ·å§‹åœ°å€ï¼ˆé»˜è®¤å€¼ 0x00ï¼‰
        __OLED_Send_Command(0x10);     // è®¾ç½®é«˜åˆ—èµ·å§‹åœ°å€ï¼ˆé»˜è®¤å€¼ 0x10ï¼‰

        /* 8 ä¸ª é¡µï¼ˆPAGEï¼‰ çš„ 128 åˆ—ï¼ˆSEGï¼‰ å…¨éƒ¨å†™ 1 */
        for (j = 0; j < 128; j++)
            __OLED_Send_Data(1);
    }
}

/**
 * @brief OLED è®¾ç½®åæ ‡ï¼ˆèµ·å§‹åœ°å€ï¼‰
 *
 * @param x æ¨ªåæ ‡ï¼Œè®¾ç½®åˆ—ï¼ˆSEGï¼‰èµ·å§‹åœ°å€ï¼ˆSEG = x, x=0..127ï¼‰
 * @param y çºµåæ ‡ï¼Œè®¾ç½®é¡µï¼ˆPAGEï¼‰èµ·å§‹åœ°å€ï¼ˆPAGE = y, y=0..7ï¼‰
 */
void __OLED_Set_Pos(uint8_t x, uint8_t y)
{
    __OLED_Send_Command(0xB0 + y);
    __OLED_Send_Command(((x & 0xF0) >> 4) | 0x10); // è®¾ç½®é«˜åˆ—åœ°å€
    __OLED_Send_Command((x & 0x0F));               // è®¾ç½®ä½åˆ—åœ°å€
}

/**
 * @brief OLED æ˜¾ç¤ºå­—ç¬¦
 *
 * @param x æ¨ªåæ ‡ï¼Œè®¾ç½®åˆ—ï¼ˆSEGï¼‰èµ·å§‹åœ°å€ï¼ˆSEG = x, x=0..127ï¼‰
 * @param y çºµåæ ‡ï¼Œè®¾ç½®é¡µï¼ˆPAGEï¼‰èµ·å§‹åœ°å€ï¼ˆPAGE = y, y=0..7ï¼‰
 * @param ch è¦æ˜¾ç¤ºçš„å­—ç¬¦
 * @param size å­—ä½“å¤§å°
 *
 * @note
 * - ç†æƒ³æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå­—ç¬¦å ä¸¤ä¸ª PAGEï¼Œä¸€ä¸ª PAGE å  8 ä¸ª SEG
 *   å­—ç¬¦å­—ä½“å¤§å° 16ï¼ˆå­—é«˜ 16ï¼Œå­—å®½ 8ï¼‰
 * - å…¶ä»–æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå­—ç¬¦å ä¸€ä¸ª PAGEï¼Œä¸€ä¸ª PAGE å  6 ä¸ª SEG
 *   å­—ç¬¦å­—ä½“å¤§å° 8ï¼ˆå­—é«˜ 8ï¼Œå­—å®½ 6ï¼‰
 */
void __OLED_ShowChar(uint8_t x, uint8_t y, char ch, uint8_t size)
{
    uint8_t i = 0;
    uint8_t index = ch - ' '; // å¾—åˆ°åç§»åçš„å€¼

    /* å¦‚æœè¿™ä¸€è¡Œå†™ä¸ä¸‹ï¼Œå°±å†™åˆ°ä¸‹ä¸€è¡Œï¼ˆPAGE+2ï¼‰çš„å¼€å¤´(SEG=0) */
    if (x > 127 - 8 + 1)
    {
        x = 0;
        y = y + 2;
    }

    /* å¦‚æœ size=16ï¼Œåˆ™æ˜¾ç¤ºå­—ç¬¦ä¸ºå­—é«˜=16ï¼Œå­—å®½=8 */
    if (size == 16)
    {
        __OLED_Set_Pos(x, y);
        for (i = 0; i < 8; i++)
            __OLED_Send_Data(F8X16[index * 16 + i]); // ä¸ŠåŠéƒ¨åˆ†
        __OLED_Set_Pos(x, y + 1);
        for (i = 0; i < 8; i++)
            __OLED_Send_Data(F8X16[index * 16 + i + 8]); // ä¸‹åŠéƒ¨åˆ†
    }
    /* size!=16 æ—¶ï¼Œæ˜¾ç¤ºå­—ç¬¦ä¸ºå­—é«˜=8ï¼Œå­—å®½=6 */
    else
    {
        __OLED_Set_Pos(x, y);
        for (i = 0; i < 6; i++)
            __OLED_Send_Data(F6x8[index][i]);
    }
}

/**
 * @brief OLED æ˜¾ç¤ºå­—ç¬¦ä¸²
 *
 * @param x æ¨ªåæ ‡ï¼Œè®¾ç½®åˆ—ï¼ˆSEGï¼‰èµ·å§‹åœ°å€ï¼ˆSEG = x, x=0..127ï¼‰
 * @param y çºµåæ ‡ï¼Œè®¾ç½®é¡µï¼ˆPAGEï¼‰èµ·å§‹åœ°å€ï¼ˆPAGE = y, y=0..7ï¼‰
 * @param str è¦æ˜¾ç¤ºçš„å­—ç¬¦ä¸²
 * @param size å­—ä½“å¤§å°
 *
 * @note ç†æƒ³æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå­—ç¬¦å ä¸¤ä¸ª PAGEï¼Œä¸€ä¸ª PAGE å  8 ä¸ª SEG
 *       å­—ç¬¦å­—ä½“å¤§å° 16ï¼ˆå­—é«˜ 16ï¼Œå­—å®½ 8ï¼‰
 * @see __OLED_ShowChar()
 */
void __OLED_ShowStr(uint8_t x, uint8_t y, char *str, uint8_t size)
{
    /* è°ƒç”¨ __OLED_ShowChar() æ˜¾ç¤ºå­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ */
    while (*str != '\0')
    {
        __OLED_ShowChar(x, y, *str++, size);
        x += 8;
        /* ğŸ‘† è™½ç„¶å¯èƒ½è¾“å‡ºå­—é«˜ä¸º 8 å­—å®½ä¸º 6 çš„å­—ç¬¦ï¼Œä½†æ˜¯æ‰€å çš„å®½åº¦ä¾ç„¶æ˜¯ 8 */

        /* å¦‚æœè¿™ä¸€è¡Œå†™ä¸ä¸‹ï¼Œå°±å†™åˆ°ä¸‹ä¸€è¡Œï¼ˆPAGE+2ï¼‰çš„å¼€å¤´(SEG=0) */
        if (x > 127 - 8 + 1)
        {
            x = 0;
            y = y + 2;
        }
    }
}

/**
 * @brief OLED æ˜¾ç¤ºä¸­æ–‡å­—ç¬¦
 *
 * @param x æ¨ªåæ ‡ï¼Œè®¾ç½®åˆ—ï¼ˆSEGï¼‰èµ·å§‹åœ°å€ï¼ˆSEG = x, x=0..127ï¼‰
 * @param y çºµåæ ‡ï¼Œè®¾ç½®é¡µï¼ˆPAGEï¼‰èµ·å§‹åœ°å€ï¼ˆPAGE = y, y=0..7ï¼‰
 * @param index è¦æ˜¾ç¤ºçš„ä¸­æ–‡å­—ç¬¦åœ¨æ•°ç»„ F16X16 ä¸­çš„ç´¢å¼•ï¼ˆä½äº oledfont.hï¼‰
 * @param size å­—ä½“å¤§å°
 *
 * @note ç†æƒ³æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå­—ç¬¦å ä¸¤ä¸ª PAGEï¼Œä¸€ä¸ª PAGE å  16 ä¸ª SEG
 *       å­—ç¬¦å­—ä½“å¤§å° 16ï¼ˆå­—é«˜=å­—å®½=16ï¼‰
 */
void __OLED_ShowChineseChar(uint8_t x, uint8_t y, uint8_t index, uint8_t size)
{
    uint8_t i = 0;

    /* å¦‚æœè¿™ä¸€è¡Œå†™ä¸ä¸‹ï¼Œå°±å†™åˆ°ä¸‹ä¸€è¡Œï¼ˆPAGE+2ï¼‰çš„å¼€å¤´(SEG=0) */
    if (x > 127 - 16 + 1)
    {
        x = 0;
        y = y + 2;
    }

    if (size == 16)
    {
        /* å…ˆæ˜¾ç¤ºä¸ŠåŠéƒ¨åˆ†ï¼ˆé«˜ 8ï¼Œå®½ 16ï¼‰ */
        __OLED_Set_Pos(x, y);
        for (i = 0; i < 16; i++)
            __OLED_Send_Data(F16X16[index * 32 + i]);

        /* å†æ˜¾ç¤ºä¸‹åŠéƒ¨åˆ†ï¼ˆPAGE+1ï¼Œé«˜ 8ï¼Œå®½ 16ï¼‰ */
        __OLED_Set_Pos(x, y + 1);
        for (i = 0; i < 16; i++)
            __OLED_Send_Data(F16X16[index * 32 + i + 16]);
    }
}

/**
 * @brief OLED æ˜¾ç¤ºï¼ˆä¸€ä¸²ï¼‰æ•°å­—
 *
 * @param x æ¨ªåæ ‡ï¼Œè®¾ç½®åˆ—ï¼ˆSEGï¼‰èµ·å§‹åœ°å€ï¼ˆSEG = x, x=0..127ï¼‰
 * @param y çºµåæ ‡ï¼Œè®¾ç½®é¡µï¼ˆPAGEï¼‰èµ·å§‹åœ°å€ï¼ˆPAGE = y, y=0..7ï¼‰
 * @param num è¦æ˜¾ç¤ºçš„æ•°å­—ï¼ˆå¯ä»¥æ˜¯è´Ÿæ•°ï¼‰
 * @param size å­—ä½“å¤§å°
 *
 * @see __OLED_ShowStr()
 */
void __OLED_ShowNum(uint8_t x, uint8_t y, int num, uint8_t size)
{
    /* stm32 çš„ int ä¸º 32 ä½ï¼ŒèŒƒå›´ï¼š-2147483648 ~ 2147483647 */
    char str[12]; // 12 åˆšå¥½å¤Ÿé•¿

    /* æ•°å­—è½¬å­—ç¬¦ä¸² */
    __OLED_Int2Str(num, str);

    /* è°ƒç”¨ __OLED_ShowStr() æ˜¾ç¤ºå­—ç¬¦ä¸² */
    __OLED_ShowStr(x, y, str, size);
}

/**
 * @brief å­—ç¬¦ä¸²è½¬æ•°å­—ï¼ˆint to char* ï¼‰
 *
 * @param num è¦è½¬æ¢çš„æ•°å­—
 * @param str è½¬æ¢å¾—åˆ°çš„å­—ç¬¦ä¸²
 */
void __OLED_Int2Str(int num, char *str)
{
    /* 0 å’Œ -2147483648(INT32_MIN) åšç‰¹æ®Šå¤„ç† */
    if (num == 0)
    {
        str[0] = '0';
        str[1] = '\0';
    }
    else if (num == INT32_MIN) // ç›´æ¥å†™ -2147483648 ä¼šæœ‰è­¦å‘Šï¼Œå› ä¸ºè¯­æ³•æ£€æŸ¥æ˜¯å…ˆçœ‹æ•°å­—å†çœ‹è´Ÿå·ï¼Œ2147483648 ä¼šè¢«çœ‹ä½œ long long
    {
        /* æ²¡æƒ³åˆ°ä»€ä¹ˆå¥½åŠæ³•ï¼Œè°ƒåº“å¯èƒ½æ›´æ…¢ï¼Œå¹²è„†ç›´æ¥ä¸€ä¸ªä¸ªå¾€é‡Œå†™ */
        str[0] = '-';
        str[1] = '2';
        str[2] = '1';
        str[3] = '4';
        str[4] = '7';
        str[5] = '4';
        str[6] = '8';
        str[7] = '3';
        str[8] = '6';
        str[9] = '4';
        str[10] = '8';
        str[11] = '\0';
    }
    else /* æ•°å­—è½¬å­—ç¬¦ä¸² */
    {
        uint8_t length = 0;
        uint8_t left = 0;
        uint8_t right = 0;
        char temp;

        /* è´Ÿæ•°è½¬æ­£ï¼Œå­—ç¬¦ä¸²é¦–å­—ç¬¦ä¸º '-' */
        if (num < 0)
        {
            str[length++] = '-';
            num = -num;
            left = 1; // åè½¬çš„æ—¶å€™æ’é™¤è´Ÿå·
        }

        /* å€’åºå†™å…¥å­—ç¬¦ä¸² */
        while (num)
        {
            str[length++] = num % 10 + '0';
            num /= 10;
        }

        /* æœ«å°¾åŠ  '\0' */
        str[length] = '\0';

        right = length - 1; // left é»˜è®¤æ˜¯ 0ï¼Œè´Ÿæ•°çš„è¯å°±æ˜¯ 1
        /* å­—ç¬¦ä¸²åè½¬ï¼ˆ'-' å’Œ '\0' åœ¨å·¦å³è¾¹ç•Œå¤–ï¼‰ */
        while (left < right)
        {
            temp = str[left];
            str[left] = str[right];
            str[right] = temp;
            left++;
            right--;
        }
    }
}

/**
 * @brief æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦ï¼ˆASCIIï¼Œå­—é«˜ 16ï¼Œå­—å®½ 8ï¼‰
 *
 * @param row æ˜¾ç¤ºåœ¨ç¬¬å‡ è¡Œï¼ˆ0~3ï¼‰
 * @param col æ˜¾ç¤ºåœ¨ç¬¬å‡ åˆ—ï¼ˆ0~15ï¼‰
 * @param ch è¦æ˜¾ç¤ºçš„å­—ç¬¦
 */
void OLED_ShowChar(uint8_t row, uint8_t col, char ch)
{
    __OLED_ShowChar(col * 8, row * 2, ch, 16);
}

/**
 * @brief æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆASCIIï¼Œå­—é«˜ 16ï¼Œå­—å®½ 8ï¼‰
 *
 * @param row ä»ç¬¬å‡ è¡Œå¼€å§‹æ˜¾ç¤ºï¼ˆ0~3ï¼‰
 * @param col ä»ç¬¬å‡ åˆ—å¼€å§‹æ˜¾ç¤ºï¼ˆ0~15ï¼‰
 * @param str æŒ‡å‘è¦æ˜¾ç¤ºçš„å­—ç¬¦ä¸²çš„æŒ‡é’ˆ
 *
 * @note å¤ªé•¿äº†ä¼šæ¢è¡Œï¼Œæ¯è¡Œæœ€å¤šæ˜¾ç¤º 16 ä¸ªå­—ç¬¦
 */
void OLED_ShowStr(uint8_t row, uint8_t col, char *str)
{
    __OLED_ShowStr(col * 8, row * 2, str, 16);
}

/**
 * @brief æ˜¾ç¤ºä¸€ä¸ªæ•°å­—ï¼ˆå­—é«˜ 16ï¼Œå­—å®½ 8ï¼‰
 *
 * @param row æ˜¾ç¤ºåœ¨ç¬¬å‡ è¡Œï¼ˆ0~3ï¼‰
 * @param col æ˜¾ç¤ºåœ¨ç¬¬å‡ åˆ—ï¼ˆ0~15ï¼‰
 * @param num è¦æ˜¾ç¤ºçš„æ•°å­—
 *
 * @note å¤ªé•¿äº†ä¼šæ¢è¡Œï¼Œæ¯è¡Œæœ€å¤šæ˜¾ç¤º 16 ä¸ªæ•°å­—
 */
void OLED_ShowNum(uint8_t row, uint8_t col, int num)
{
    __OLED_ShowNum(col * 8, row * 2, num, 16);
}

/**
 * @brief æ˜¾ç¤ºä¸€ä¸ªä¸­æ–‡å­—ç¬¦ï¼ˆå­—é«˜ 16ï¼Œå­—å®½ 16ï¼‰
 * @note å‡†ç¡®çš„è¯´å…¶å®æ˜¯å…¨å®½å­—ç¬¦ï¼Œå…·ä½“è¾“å‡ºä»€ä¹ˆå–å†³äºæ•°ç»„ F16X16
 *
 * @param row ä»ç¬¬å‡ è¡Œå¼€å§‹æ˜¾ç¤ºï¼ˆ0~3ï¼‰
 * @param col ä»ç¬¬å‡ åˆ—å¼€å§‹æ˜¾ç¤ºï¼ˆ0~7ï¼‰
 * @param index è¦æ˜¾ç¤ºçš„ä¸­æ–‡å­—ç¬¦çš„ç´¢å¼•ï¼ˆåœ¨ oledfont.h çš„ æ•°ç»„ F16X16 é‡Œï¼‰
 */
void OLED_ShowChineseChar(uint8_t row, uint8_t col, uint8_t index)
{
    __OLED_ShowChineseChar(col * 16, row * 2, index, 16);
}

/* TODO
 *
 * 1. å¯ä»¥æ˜¾ç¤ºå‰å¯¼ 0 çš„ ShowNum å‡½æ•°
 *    OLED_ShowNum_With_Leading_Zero(uint8_t row, uint8_t col, int num, uint8_t length)
 *
 * 2. å¯ä»¥æ˜¾ç¤ºå°æ•°ç‚¹çš„ ShowNum å‡½æ•°
 *    OLED_ShowNum_With_Dot(uint8_t row, uint8_t col, float num)
 */
